\batchmode
\documentclass[oneside,10pt]{book}
\RequirePackage{ifthen}

\usepackage[paperwidth=118.8mm,paperheight=68.2mm,margin=2mm]{geometry}%
\renewcommand{\familydefault}{\sfdefault}\normalfont\usepackage[unicode,colorlinks=true]{hyperref}\usepackage{xcolor}
\definecolor{red}{rgb}{0.7, 0, 0}
\definecolor{green}{rgb}{0, 0.4, 0}
\definecolor{blue}{rgb}{0, 0, 0.7}


\usepackage{enumitem}

%
\providecommand{\email}[1]{\textless\href{mailto:#1}{#1}\textgreater} 
%
\renewcommand{\emph}[1]{\textcolor{blue}{#1}}%
\providecommand{\note}[1]{\,\footnote{\ #1}}%
\providecommand{\term}[1]{\textcolor{green}{#1}} 
\usepackage{soul}
\usepackage{framed}\usepackage[toc]{appendix} 
%
\providecommand{\cpp}{$C^{++}$}%
\providecommand{\F}{FORTH}%
\providecommand{\py}{Python}%
\providecommand{\ST}{SmallTalk}%
\providecommand{\java}{Java}%
\providecommand{\JS}{JavaScript} 


\usepackage{listings}
\lstset{
basicstyle=\small ,
tabsize=4,
commentstyle=\color{blue}\textbf,
frame=single,
showstringspaces=false,
}


\usepackage[pdftex]{graphicx}%
\providecommand{\fig}[2]{{\centering\noindent\includegraphics[#2]{#1}}} 


\title{GNU Dynamic Language Runtime}
\author{\copyright\ Dmitry Ponyatov \email{dponyatov@gmail.com}}




\usepackage[dvips]{color}


\pagecolor[gray]{.7}

\usepackage[latin1]{inputenc}



\makeatletter

\makeatletter
\count@=\the\catcode`\_ \catcode`\_=8 
\newenvironment{tex2html_wrap}{}{}%
\catcode`\<=12\catcode`\_=\count@
\newcommand{\providedcommand}[1]{\expandafter\providecommand\csname #1\endcsname}%
\newcommand{\renewedcommand}[1]{\expandafter\providecommand\csname #1\endcsname{}%
  \expandafter\renewcommand\csname #1\endcsname}%
\newcommand{\newedenvironment}[1]{\newenvironment{#1}{}{}\renewenvironment{#1}}%
\let\newedcommand\renewedcommand
\let\renewedenvironment\newedenvironment
\makeatother
\let\mathon=$
\let\mathoff=$
\ifx\AtBeginDocument\undefined \newcommand{\AtBeginDocument}[1]{}\fi
\newbox\sizebox
\setlength{\hoffset}{0pt}\setlength{\voffset}{0pt}
\addtolength{\textheight}{\footskip}\setlength{\footskip}{0pt}
\addtolength{\textheight}{\topmargin}\setlength{\topmargin}{0pt}
\addtolength{\textheight}{\headheight}\setlength{\headheight}{0pt}
\addtolength{\textheight}{\headsep}\setlength{\headsep}{0pt}
\setlength{\textwidth}{349pt}
\newwrite\lthtmlwrite
\makeatletter
\let\realnormalsize=\normalsize
\global\topskip=2sp
\def\preveqno{}\let\real@float=\@float \let\realend@float=\end@float
\def\@float{\let\@savefreelist\@freelist\real@float}
\def\liih@math{\ifmmode$\else\bad@math\fi}
\def\end@float{\realend@float\global\let\@freelist\@savefreelist}
\let\real@dbflt=\@dbflt \let\end@dblfloat=\end@float
\let\@largefloatcheck=\relax
\let\if@boxedmulticols=\iftrue
\def\@dbflt{\let\@savefreelist\@freelist\real@dbflt}
\def\adjustnormalsize{\def\normalsize{\mathsurround=0pt \realnormalsize
 \parindent=0pt\abovedisplayskip=0pt\belowdisplayskip=0pt}%
 \def\phantompar{\csname par\endcsname}\normalsize}%
\def\lthtmltypeout#1{{\let\protect\string \immediate\write\lthtmlwrite{#1}}}%
\newcommand\lthtmlhboxmathA{\adjustnormalsize\setbox\sizebox=\hbox\bgroup\kern.05em }%
\newcommand\lthtmlhboxmathB{\adjustnormalsize\setbox\sizebox=\hbox to\hsize\bgroup\hfill }%
\newcommand\lthtmlvboxmathA{\adjustnormalsize\setbox\sizebox=\vbox\bgroup %
 \let\ifinner=\iffalse \let\)\liih@math }%
\newcommand\lthtmlboxmathZ{\@next\next\@currlist{}{\def\next{\voidb@x}}%
 \expandafter\box\next\egroup}%
\newcommand\lthtmlmathtype[1]{\gdef\lthtmlmathenv{#1}}%
\newcommand\lthtmllogmath{\dimen0\ht\sizebox \advance\dimen0\dp\sizebox
  \ifdim\dimen0>.95\vsize
   \lthtmltypeout{%
*** image for \lthtmlmathenv\space is too tall at \the\dimen0, reducing to .95 vsize ***}%
   \ht\sizebox.95\vsize \dp\sizebox\z@ \fi
  \lthtmltypeout{l2hSize %
:\lthtmlmathenv:\the\ht\sizebox::\the\dp\sizebox::\the\wd\sizebox.\preveqno}}%
\newcommand\lthtmlfigureA[1]{\let\@savefreelist\@freelist
       \lthtmlmathtype{#1}\lthtmlvboxmathA}%
\newcommand\lthtmlpictureA{\bgroup\catcode`\_=8 \lthtmlpictureB}%
\newcommand\lthtmlpictureB[1]{\lthtmlmathtype{#1}\egroup
       \let\@savefreelist\@freelist \lthtmlhboxmathB}%
\newcommand\lthtmlpictureZ[1]{\hfill\lthtmlfigureZ}%
\newcommand\lthtmlfigureZ{\lthtmlboxmathZ\lthtmllogmath\copy\sizebox
       \global\let\@freelist\@savefreelist}%
\newcommand\lthtmldisplayA{\bgroup\catcode`\_=8 \lthtmldisplayAi}%
\newcommand\lthtmldisplayAi[1]{\lthtmlmathtype{#1}\egroup\lthtmlvboxmathA}%
\newcommand\lthtmldisplayB[1]{\edef\preveqno{(\theequation)}%
  \lthtmldisplayA{#1}\let\@eqnnum\relax}%
\newcommand\lthtmldisplayZ{\lthtmlboxmathZ\lthtmllogmath\lthtmlsetmath}%
\newcommand\lthtmlinlinemathA{\bgroup\catcode`\_=8 \lthtmlinlinemathB}
\newcommand\lthtmlinlinemathB[1]{\lthtmlmathtype{#1}\egroup\lthtmlhboxmathA
  \vrule height1.5ex width0pt }%
\newcommand\lthtmlinlineA{\bgroup\catcode`\_=8 \lthtmlinlineB}%
\newcommand\lthtmlinlineB[1]{\lthtmlmathtype{#1}\egroup\lthtmlhboxmathA}%
\newcommand\lthtmlinlineZ{\egroup\expandafter\ifdim\dp\sizebox>0pt %
  \expandafter\centerinlinemath\fi\lthtmllogmath\lthtmlsetinline}
\newcommand\lthtmlinlinemathZ{\egroup\expandafter\ifdim\dp\sizebox>0pt %
  \expandafter\centerinlinemath\fi\lthtmllogmath\lthtmlsetmath}
\newcommand\lthtmlindisplaymathZ{\egroup %
  \centerinlinemath\lthtmllogmath\lthtmlsetmath}
\def\lthtmlsetinline{\hbox{\vrule width.1em \vtop{\vbox{%
  \kern.1em\copy\sizebox}\ifdim\dp\sizebox>0pt\kern.1em\else\kern.3pt\fi
  \ifdim\hsize>\wd\sizebox \hrule depth1pt\fi}}}
\def\lthtmlsetmath{\hbox{\vrule width.1em\kern-.05em\vtop{\vbox{%
  \kern.1em\kern0.8 pt\hbox{\hglue.17em\copy\sizebox\hglue0.8 pt}}\kern.3pt%
  \ifdim\dp\sizebox>0pt\kern.1em\fi \kern0.8 pt%
  \ifdim\hsize>\wd\sizebox \hrule depth1pt\fi}}}
\def\centerinlinemath{%
  \dimen1=\ifdim\ht\sizebox<\dp\sizebox \dp\sizebox\else\ht\sizebox\fi
  \advance\dimen1by.5pt \vrule width0pt height\dimen1 depth\dimen1 
 \dp\sizebox=\dimen1\ht\sizebox=\dimen1\relax}

\def\lthtmlcheckvsize{\ifdim\ht\sizebox<\vsize 
  \ifdim\wd\sizebox<\hsize\expandafter\hfill\fi \expandafter\vfill
  \else\expandafter\vss\fi}%
\providecommand{\selectlanguage}[1]{}%
\makeatletter \tracingstats = 1 


\begin{document}
\pagestyle{empty}\thispagestyle{empty}\lthtmltypeout{}%
\lthtmltypeout{latex2htmlLength hsize=\the\hsize}\lthtmltypeout{}%
\lthtmltypeout{latex2htmlLength vsize=\the\vsize}\lthtmltypeout{}%
\lthtmltypeout{latex2htmlLength hoffset=\the\hoffset}\lthtmltypeout{}%
\lthtmltypeout{latex2htmlLength voffset=\the\voffset}\lthtmltypeout{}%
\lthtmltypeout{latex2htmlLength topmargin=\the\topmargin}\lthtmltypeout{}%
\lthtmltypeout{latex2htmlLength topskip=\the\topskip}\lthtmltypeout{}%
\lthtmltypeout{latex2htmlLength headheight=\the\headheight}\lthtmltypeout{}%
\lthtmltypeout{latex2htmlLength headsep=\the\headsep}\lthtmltypeout{}%
\lthtmltypeout{latex2htmlLength parskip=\the\parskip}\lthtmltypeout{}%
\lthtmltypeout{latex2htmlLength oddsidemargin=\the\oddsidemargin}\lthtmltypeout{}%
\makeatletter
\if@twoside\lthtmltypeout{latex2htmlLength evensidemargin=\the\evensidemargin}%
\else\lthtmltypeout{latex2htmlLength evensidemargin=\the\oddsidemargin}\fi%
\lthtmltypeout{}%
\makeatother
\setcounter{page}{1}
\onecolumn

% !!! IMAGES START HERE !!!

\stepcounter{section}
\stepcounter{section}
\stepcounter{part}
\stepcounter{section}
\stepcounter{chapter}
\stepcounter{section}
\stepcounter{section}
\stepcounter{section}
\stepcounter{section}


\setlength{\topsep}{0pt}%

\setlength{\topsep}{0pt}
{\newpage\clearpage
\lthtmlfigureA{framed247}%
\begin{framed}
The key property: compiler \emph{compiles but not executes program}
\end{framed}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

{\newpage\clearpage
\lthtmlfigureA{framed251}%
\begin{framed}
Interpreter is a computer program written in language L \emph{executes} program
written in language P.
\end{framed}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

\stepcounter{section}
\stepcounter{section}
\stepcounter{section}
\stepcounter{chapter}
\stepcounter{section}
{\newpage\clearpage
\lthtmlfigureA{lstlisting343}%
\begin{lstlisting}
0000 <function nop at 0x7ff7bb790b18>
0001 <function bye at 0x7ff7bb790c08>
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

\stepcounter{section}
{\newpage\clearpage
\lthtmlfigureA{lstlisting347}%
\begin{lstlisting}
0000 <unbound method VM.nop>
0001 <unbound method VM.bye>
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

\stepcounter{section}
{\newpage\clearpage
\lthtmlfigureA{lstlisting359}%
\begin{lstlisting}
0000 <unbound method VM.ld> [0, 1, 2, 3, 4, 5, 6, 7]
0003 <unbound method VM.nop> [0, 'R[1]', 2, 3, 4, 5, 6, 7]
0004 <unbound method VM.bye> [0, 'R[1]', 2, 3, 4, 5, 6, 7]
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

{\newpage\clearpage
\lthtmlfigureA{lstlisting366}%
\begin{lstlisting}
<command> <addr1> <addr2> <addr3> 
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

\stepcounter{section}
\stepcounter{chapter}
\stepcounter{chapter}
{\newpage\clearpage
\lthtmlinlinemathA{tex2html_wrap_inline830}%
$C^{++}$%
\lthtmlinlinemathZ
\lthtmlcheckvsize\clearpage}

\stepcounter{section}
\stepcounter{section}
\stepcounter{chapter}
\stepcounter{part}
\stepcounter{chapter}
\stepcounter{chapter}
\stepcounter{part}
\stepcounter{chapter}
\stepcounter{chapter}
\stepcounter{chapter}
\stepcounter{chapter}
\stepcounter{section}
\stepcounter{part}
\stepcounter{section}
\stepcounter{section}
{\newpage\clearpage
\lthtmlfigureA{lstlisting908}%
\begin{lstlisting}[language=C]
#define Msz 0x1000		/* bytes */
#define Rsz 0x100
#define Dsz 0x10 
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

{\newpage\clearpage
\lthtmlfigureA{lstlisting911}%
\begin{lstlisting}[language=C]
#define CELL sizeof(int32_t)
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

\stepcounter{subsection}
{\newpage\clearpage
\lthtmlfigureA{lstlisting914}%
\begin{lstlisting}[language=C]
extern uint8_t  M[Msz];	// memory
extern uint32_t Ip=0;	// instruction pointer
extern uint32_t Cp=0;	// compilation pointer (free heap)
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

{\newpage\clearpage
\lthtmlfigureA{lstlisting920}%
\begin{lstlisting}[language=C]
extern void set(uint32_t addr, int32_t value);
extern uint32_t get(uint32_t addr);
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

{\newpage\clearpage
\lthtmlfigureA{lstlisting923}%
\begin{lstlisting}[language=C++]
void set(uint32_t addr, int32_t value) {
	assert(addr+3 < Msz);			  // check memory bound
	M[addr+0] = (value>>0x00) & 0xFF;
	M[addr+1] = (value>>0x08) & 0xFF;
	M[addr+2] = (value>>0x10) & 0xFF;
	M[addr+3] = (value>>0x18) & 0xFF;	}
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

{\newpage\clearpage
\lthtmlfigureA{lstlisting926}%
\begin{lstlisting}[language=C++]
uint32_t get(uint32_t addr) {
	assert(addr+3 < Msz);
	return \
		M[addr+0]<<0x00 | M[addr+1]<<0x08 | \
		M[addr+2]<<0x10 | M[addr+3]<<0x18;	}
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

\stepcounter{subsection}
{\newpage\clearpage
\lthtmlfigureA{lstlisting930}%
\begin{lstlisting}[language=C++]
extern uint32_t Cp;		// compilation pointer (free heap)
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

{\newpage\clearpage
\lthtmlfigureA{lstlisting935}%
\begin{lstlisting}[language=C++]
extern void Cbyte( uint8_t);	// compile byte
extern void Ccell(uint32_t);	// compile cell
extern void Cstring(char*);		// compile ASCIIZ string
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

{\newpage\clearpage
\lthtmlfigureA{lstlisting938}%
\begin{lstlisting}[language=C++]
void Cbyte( uint8_t b) {
	M[Cp++] = b; assert(Cp<Msz); }
void Ccell(uint32_t c) {
	set(Cp,c); Cp+= CELL; assert(Cp<Msz); }
void Cstring(char* s) {
	uint32_t L = strlen(s); assert(Cp+L+1<Msz);	// length
	memcpy(&M[Cp],s,L+1); Cp += L+1; }	// compile length+1
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

\stepcounter{subsection}
{\newpage\clearpage
\lthtmlfigureA{lstlisting963}%
\begin{lstlisting}[language=C++]
// program entry point (addr of jmp parameter)
#define _entry  1
// last defined word LFA address
#define _latest (_entry+CELL)
\par
int main(int argc, char *argv[]) {
	// ============ compile vocabulary header
	// jmp _entry	jump to last defined word
	Cbyte(opJMP); Ccell(0);
	// _latest		LFA of last defined word
	Ccell(0);
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

{\newpage\clearpage
\lthtmlfigureA{lstlisting965}%
\begin{lstlisting}[language=C++]
map<string,uint32_t> SymTable;				// symbol table
\par
void LFA() {
	uint32_t L = get(_latest); set(_latest,Cp); Ccell(L); }
void AFA(uint8_t b) { 
	Cbyte(b); }
void NFA(char* s) { 
	Cstring(s); }
void CFA(string name) { 
	SymTable[name] = Cp; set(_entry,Cp); }
void Cheader(char* name) {				  // compile header
	LFA(); AFA(); NFA(name); CFA(name); }
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

\stepcounter{subsection}
{\newpage\clearpage
\lthtmlfigureA{lstlisting973}%
\begin{lstlisting}[language=C++]
int main() {
	...						// compile vocabulary header
	yyparse();				// run compiler
	dump();					// dump memory into .bin file
	VM();					// run VM
}	
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

{\newpage\clearpage
\lthtmlfigureA{lstlisting976}%
\begin{lstlisting}[language=C++]
void VM() { for (;;) {						// infty loop
	printf("%
uint8_t op = M[Ip++]; assert(Ip<=Cp);		 // FETCH
	printf("%
switch (op) {						// DECODE/EXECUTE
		case opNOP : nop();  break;
		case opBYE : bye();  break;
		case opJMP : jmp();  break;
		case opCALL: call(); break;
		case opRET : ret();  break;
		case opLIT : lit();  break;
		default:
			printf("bad opcode\n\n"); abort();
	}
	printf("\n");
}}
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

\stepcounter{section}
{\newpage\clearpage
\lthtmlfigureA{lstlisting982}%
\begin{lstlisting}[title=ypp.ypp: yacc syntax parser]\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

\stepcounter{subsection}
{\newpage\clearpage
\lthtmlfigureA{lstlisting985}%
\begin{lstlisting}[language=C++]
#define opNOP	0x00	// nop
#define opBYE	0xFF	// bye
#define opJMP	0x01	// jmp <addr>
#define opQJMP	0x02	// ?jmp <addr>
#define opCALL	0x03	// call <addr>
#define opRET	0x04	// ret
#define opLIT	0x05	// lit <value>
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

{\newpage\clearpage
\lthtmlfigureA{lstlisting988}%
\begin{lstlisting}[language=C++]
#define opNOP	0x00	// nop
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

{\newpage\clearpage
\lthtmlfigureA{lstlisting990}%
\begin{lstlisting}[language=C++]
void nop() { printf("nop"); }
\end{lstlisting}%
\lthtmlfigureZ
\lthtmlcheckvsize\clearpage}

\stepcounter{subsection}
\stepcounter{subsection}
\stepcounter{subsection}
\stepcounter{subsection}
\stepcounter{section}
\stepcounter{subsection}
\stepcounter{subsection}
\stepcounter{subsection}
\stepcounter{section}
\stepcounter{subsection}
\stepcounter{subsection}
\stepcounter{subsection}
\stepcounter{section}
\stepcounter{subsection}
\stepcounter{subsection}
\stepcounter{subsection}
\stepcounter{subsection}
\stepcounter{section}
\stepcounter{subsection}
\stepcounter{subsection}
\stepcounter{part}
\stepcounter{chapter}
\stepcounter{section}
\stepcounter{chapter}
\stepcounter{section}
\stepcounter{section}
\stepcounter{chapter}
\stepcounter{section}
\stepcounter{section}

\end{document}
